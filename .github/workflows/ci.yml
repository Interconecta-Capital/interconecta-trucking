name: CI/CD Pipeline - FASE 4

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================================================
  # JOB 1: TESTS UNITARIOS E INTEGRACIÓN
  # ============================================================================
  test:
    name: Tests (Unit + Integration)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Instalar dependencias
        run: bun install --frozen-lockfile

      - name: Ejecutar tests unitarios
        run: bun run test:unit
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Ejecutar tests de integración
        run: bun run test:integration
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Generar reporte de cobertura
        run: bun run test:coverage

      - name: Subir reporte de cobertura
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella

  # ============================================================================
  # JOB 2: LINTING Y FORMATEO
  # ============================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Instalar dependencias
        run: bun install --frozen-lockfile

      - name: Ejecutar ESLint
        run: bun run lint

      - name: Verificar formateo con Prettier
        run: bun run format:check

  # ============================================================================
  # JOB 3: ANÁLISIS DE SEGURIDAD
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Ejecutar análisis de vulnerabilidades
        run: bun audit

      - name: Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # ============================================================================
  # JOB 4: BUILD VERIFICATION
  # ============================================================================
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Instalar dependencias
        run: bun install --frozen-lockfile

      - name: Build del proyecto
        run: bun run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Verificar tamaño del bundle
        run: |
          BUNDLE_SIZE=$(du -sh dist | cut -f1)
          echo "Bundle size: $BUNDLE_SIZE"
          # Alerta si el bundle es > 5MB
          if [ $(du -s dist | cut -f1) -gt 5000 ]; then
            echo "⚠️ Warning: Bundle size exceeds 5MB"
          fi

  # ============================================================================
  # JOB 5: SUPABASE MIGRATIONS CHECK
  # ============================================================================
  database:
    name: Database Migrations Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validar migraciones SQL
        run: |
          # Verificar sintaxis SQL
          for file in supabase/migrations/*.sql; do
            echo "Validando $file..."
            # Aquí puedes añadir validación de sintaxis SQL
          done

      - name: Verificar funciones SECURITY DEFINER
        run: |
          # Verificar que funciones SECURITY DEFINER tienen search_path
          if grep -r "SECURITY DEFINER" supabase/migrations/ | grep -v "SET search_path"; then
            echo "❌ Error: Funciones SECURITY DEFINER sin search_path encontradas"
            exit 1
          else
            echo "✅ Todas las funciones SECURITY DEFINER tienen search_path"
          fi

  # ============================================================================
  # JOB 6: NOTIFICACIONES
  # ============================================================================
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [test, lint, security, build, database]
    if: always()
    
    steps:
      - name: Enviar notificación de éxito
        if: needs.test.result == 'success' && needs.lint.result == 'success' && needs.build.result == 'success'
        run: |
          echo "✅ CI Pipeline completado exitosamente"
          # Aquí puedes añadir integración con Slack/Discord/Email

      - name: Enviar notificación de fallo
        if: needs.test.result == 'failure' || needs.lint.result == 'failure' || needs.build.result == 'failure'
        run: |
          echo "❌ CI Pipeline falló"
          # Aquí puedes añadir integración con Slack/Discord/Email
